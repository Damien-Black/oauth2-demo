(function e$$0(n,p,k){function g(a,c){if(!p[a]){if(!n[a]){var b="function"==typeof require&&require;if(!c&&b)return b(a,!0);if(e)return e(a,!0);throw Error("Cannot find module '"+a+"'");}b=p[a]={exports:{}};n[a][0].call(b.exports,function(b){var c=n[a][1][b];return g(c?c:b)},b,b.exports,e$$0,n,p,k)}return p[a].exports}for(var e="function"==typeof require&&require,a=0;a<k.length;a++)g(k[a]);return g})({1:[function(m,n,p){n.exports=function(k,g,e){var a,d,c,b,h,l,f,r,t,q,u,m;null==g&&(g={});null==e&&
(e=0);q=$.Deferred();b=null!=(c=g.headers)?c:{};c=g.data;l=null!=(u=g.method)?u:"POST";a=g.ajaxDelay;h=null!=(m=g.maxRetries)?m:5;r=null;null!=c&&"object"===typeof c&&!0!==g.skipConversion&&(b["Content-Type"]="application/json",c=JSON.stringify(c));t=function(b){return null!=a?setTimeout(function(){return q.resolve(b)},a):q.resolve(b)};f=function(b){var c,h;null!=a?setTimeout(function(){return q.reject(b)},a):q.reject(b);return q.reject({type:"AjaxError",details:{jqXHR:null!=(c=null!=(h=b.details)?
h.jqXHR:void 0)?c:{}}})};try{d={url:k,headers:b,type:l,data:c,success:function(a){return t(a)},error:function(a,b,c){var d;if(503===a.status)return a=parseInt(a.getResponseHeader("Retry-After"),10),"[object Number]"===toString.call(a)&&!isNaN(a)&&0<a||(a=60),f({type:"AjaxRetryTimeout",details:{delay:a}}),setTimeout(function(){return DX.ajaxRequest(k,g,e).then(q.resolve,q.reject,q.notify)},1E3*a);if("error"===b&&0===a.status){if(e>h)return f({type:"AjaxError",details:{jqXHR:a}});e+=1;return setTimeout(function(){return DX.ajaxRequest(k,
g,e).then(q.resolve,q.reject,q.notify)},1E3*Math.pow(2,e))}if("abort"!==c&&"abort"!==b&&!q.aborted){c=null;if("timeout"===b)c={type:"AjaxTimeout",details:{url:k}};else if("parsererror"===b)c={type:"AjaxError",details:{data:JSON.stringify(input)}};else try{c=null!=(d=JSON.parse(a.responseText).error)?d:{type:"InvalidErrorResponse"}}catch(r){c={type:"InvalidErrorResponse",details:r}}return f(c)}}},null!=g.cache&&(d.cache=g.cache),!0===g.withCredentials&&(d.xhrFields={withCredentials:!0}),null!=g.dataType&&
(d.dataType=g.dataType),r=$.ajax(d),q.abort=function(){return r.abort()}}catch(s){console.log("Unknown error during API call",s),null!=r&&null!=r.abort&&r.abort(),f({type:"UnknownError",details:s})}return q}},{}],2:[function(m,n,p){var k,g={}.hasOwnProperty;k=m("./ajax_request.coffee");m=function(){function e(a,d){var c,b;this.authToken=a;null==d&&(d={});if(null==this.authToken||0===this.authToken.length)throw Error("authToken must be specified");this.maxAJAXTrials=null!=(c=d.maxAJAXTrials)?c:5;this.apiServer=
"https://"+(null!=(b=d.apiServer)?b:"api.dnanexus.com");this.pendingApiCallKey=0;this.pendingApiCalls={}}e.prototype.API_ERRORS={MalformedJSON:"The input could not be parsed as JSON",InvalidAuthentication:"The provided OAuth2 token is invalid",PermissionDenied:"Insufficient permissions to perform this action",ResourceNotFound:"A specified entity or resource could not be found",InvalidInput:"The input is syntactically correct (JSON), but semantically incorrect",InvalidState:"The operation is not allowed at this object state",
InvalidType:"An object specified in the request is of invalid type",InternalError:"The server encountered an internal error",InvalidErrorResponse:"We've received an error, but cannot process the message",InvalidAPICall:"An invalid api call has occurred",InvalidResponse:"We've received an invalid response from an API call",AjaxError:"There was an error in the way the server request was formed",AjaxTimeout:"The server could not be contacted in a timely fashion"};e.prototype.ALL_ERRORS="AllErrors";e.prototype.call=
function(a,d,c,b){var h,l,f;null==b&&(b={});f=$.Deferred();f.abort=function(){return this.aborted=!0};if(this.disabled)return f;if(null==a||null==d||"string"!==typeof a||"string"!==typeof d)return console.error("Subject and method must both be defined and must be strings, when calling Nucleus.call",a,d),f.reject();null==c&&(c={});h=this.pendingApiCallKey++;this.pendingApiCalls[h]=f;d=[this.apiServer,a,d].join("/");a={};a.Authorization="Bearer "+this.authToken;c={headers:a,data:c,maxRetries:this.maxAJAXTrials};
!0===b.withCredentials&&(c.withCredentials=!0);l=k(d,c);f.abort=function(){this.aborted=!0;return l.abort()};l.done(function(a){return function(a){if(!f.aborted){try{"string"===typeof a&&(a=$.parseJSON(a))}catch(b){f.reject({type:"InvalidResponse"});return}return f.resolve(a)}}}(this)).fail(function(a){return function(a){return f.reject(a)}}(this)).always(function(a){return function(){return delete a.pendingApiCalls[h]}}(this));return f};e.prototype.destroy=function(){var a,d,c,b;this.disabled=!0;
c=this.pendingApiCalls;b=[];for(a in c)g.call(c,a)&&(d=c[a],b.push(d.abort()));return b};e.prototype.getNumPendingApiCalls=function(){var a,d,c;a=0;c=this.pendingApiCalls;for(d in c)g.call(c,d)&&a++;return a};e.prototype.uploadFilePart=function(a,d,c,b,h){var l,f,r;l=$.Deferred();f={"Content-MD5":b};r=this.call(a,"upload",{index:d},h).done(function(a){var b,h,d,e,g;g=a.headers;for(h in g)e=g[h],f[h]=e;b=$.ajax({url:a.url,contentType:"application/octet-stream",processData:!1,data:c,headers:f,success:function(){return l.resolve(null)},
error:function(a,b,c){var h;try{return h=JSON.parse(a.responseText).error.type,l.reject(h)}catch(d){return l.reject(c)}},type:"POST",xhr:function(){var a,b,c;c=$.ajaxSettings.xhr();null!=c.upload&&(b=function(a){if(a.lengthComputable)return l.notify({loaded:a.loaded,total:a.total})},a=function(){c.upload.removeEventListener("progress",b);return c.upload.removeEventListener("loadend",a)},c.upload.addEventListener("progress",b),c.upload.addEventListener("loadend",a));return c}});d=r.abort;return r.abort=
function(){b.abort();return d.call(r)}}).fail(function(a){return l.reject(a)});l.abort=function(){return r.abort()};return l};return e}();n.exports=m},{"./ajax_request.coffee":1}],3:[function(m,n,p){m=function(){function k(g){this._resources=g;this._queue=[];this._closed=!1}k.prototype.acquire=function(){var g;g=$.Deferred();0<this._resources.length&&!this._closed?g.resolve(this._resources.shift()):this._queue.push(g);return g};k.prototype.close=function(){return this._closed=!0};k.prototype.getNumberAvailable=
function(){return this._closed?0:this._resources.length};k.prototype.release=function(g){return 0<this._queue.length&&!this._closed?this._queue.shift().resolve(g):this._resources.push(g)};k.prototype.open=function(){var g,e,a,d,c;if(this._closed){this._closed=!1;d=this._resources;c=[];e=0;for(a=d.length;e<a;e++)g=d[e],c.push(this.release(g));return c}};return k}();n.exports=m},{}],4:[function(m,n,p){null==window.DX&&(window.DX={});window.DX.ajaxRequest=m("./ajax_request.coffee");window.DX.Api=m("./api.coffee");
window.DX.Upload=m("./upload/upload.coffee")},{"./ajax_request.coffee":1,"./api.coffee":2,"./upload/upload.coffee":7}],5:[function(m,n,p){var k,g=function(e,a){return function(){return e.apply(a,arguments)}};k=Math.pow(1024,2);m=function(){function e(a,d){var c,b,h,l,f;this.file=a;null==d&&(d={});this._onUploadProgress=g(this._onUploadProgress,this);d=$.extend({folder:"/"},d);f="folder partSize fileCreationPool workerPool uploadPool api projectID".split(" ");h=0;for(l=f.length;h<l;h++){b=f[h];if(null==
d[b])throw Error("Required parameter "+b+" is not specified");this[b]=d[b]}this.partSize=Math.max(Math.ceil(this.file.size/1E4),this.partSize);this._uploadProgress=$.Deferred();this._checksumProgress=$.Deferred();this._closingProgress=$.Deferred();this._uploadCalls={};this._bytesResumed=this._bytesUploaded=this._uploadsDone=0;this._closed=this._closing=this._aborted=!1;this.numParts=Math.max(1,Math.ceil(this.file.size/this.partSize));this.uploadStartedAt=null;this._checksumQueue=[];this._uploadQueue=
[];this._parts=[];this._partUploadProgress=[];this.isDirectory=!1;c={folder:this.folder,tags:d.tags,properties:d.properties};this.fileCreationStatus=$.Deferred();b=function(b){return function(){return b.fileCreationPool.acquire().done(function(h){return e.prototype.findOrCreateFile(a,b.api,b.partSize,b.projectID,c).done(function(a){var c,h,d,f,l;c=null!=(d=a.parts)?d:{};b.fileID=a.fileID;a=d=0;for(f=b.numParts;0<=f?d<f:d>f;a=0<=f?++d:--d)h=b.partSize*a,h={index:a+1,start:h,stop:Math.min(b.file.size,
h+b.partSize)},b._parts.push(h),"complete"===(null!=(l=c[a+1])?l.state:void 0)?(b._uploadsDone+=1,b._bytesResumed+=h.stop-h.start):b._checksumQueue.push(h);b._onUploadProgress();return b.fileCreationStatus.resolve(b.fileID)}).fail(function(a){return b.fileCreationStatus.reject(a)}).always(function(){return b.fileCreationPool.release(h)})})}}(this);this.file.size<1*k?this.readBytes(0,10).done(b).fail(function(a){return function(){var b;a.isDirectory=!0;b={error:{type:"InvalidType",message:"File is a directory and cannot be uploaded"}};
a.fileCreationStatus.reject(b);a._uploadProgress.reject(b);a._checksumProgress.reject(b);return a._closingProgress.reject(b)}}(this)):b()}e.prototype.computeSignature=function(a,d){return[a.size,a.lastModifiedDate.getTime(),0,d,a.name].join(" ")};e.prototype.createFile=function(a,d,c,b,h){var l;null==h&&(h={});c=$.extend(h.properties,{".system-fileSignature":this.computeSignature(a,c)});a={folder:h.folder,name:a.name,project:b,properties:c};0<(null!=(l=h.tags)?l.length:void 0)&&(a.tags=h.tags);return d.call("file",
"new",a).then(function(a){return{fileID:a.id}})};e.prototype.findOrCreateFile=function(a,d,c,b,h){var l,f;null==h&&(h={});f={"class":"file",state:"open",describe:!0,properties:{".system-fileSignature":this.computeSignature(a,c)},scope:{project:b,folder:h.folder}};l=function(f){return function(){return f.createFile(a,d,c,b,h)}}(this);return d.call("system","findDataObjects",f).then(function(a){return 1===a.results.length?{fileID:a.results[0].id,parts:a.results[0].describe.parts}:l()},function(){return l()})};
e.prototype._computeChecksums=function(){var a,d,c,b;c=this._checksumQueue.length;a=0;for(b=[];0<this._checksumQueue.length;)d=this._checksumQueue.shift(),b.push(function(b){return function(d){return b.workerPool.acquire().done(function(f){var e,g,k;if(b._aborted)b.workerPool.release(f);else return e=null!=(g=null!=(k=b.file.slice)?k:b.file.webkitSlice)?g:b.file.mozSlice,e=e.call(b.file,d.start,d.stop),d.slice=e,f.computeMD5(e).done(function(e){d.md5=e;b._uploadQueue.push(d);b._doUpload();b.workerPool.release(f);
a+=1;e={partsTotal:c,partsDone:a};if(c===a)return b._checksumProgress.resolve(e);b._checksumProgress.notify(e);return b._computeChecksums()}).fail(function(a){return console.error("Error computing MD5 checksum",a)})})}}(this)(d));return b};e.prototype._closeFile=function(){var a;if(!(this._closing||this._closed||this._aborted))return this._closing=!0,a=function(d){return function(){return d.api.call(d.fileID,"describe").done(function(c){var b,h,e;h=!0;e=c.parts;for(b in e)if(c=e[b],"complete"!==c.state){h=
!1;break}return h?d.api.call(d.fileID,"close").done(function(){d._closing=!1;d._closed=!0;return d._closingProgress.resolve()}):setTimeout(a,1E3)})}}(this),a()};e.prototype._onUploadProgress=function(a,d,c){var b,h;null==c&&(c=!1);null!=d&&(this._partUploadProgress[a.index]=d.loaded);a=0;h=this._partUploadProgress;for(b in h)d=h[b],a+=d;b={bytesTotal:this.file.size,bytesUploaded:this._bytesUploaded+a,bytesDone:this._bytesResumed+this._bytesUploaded+a};return c?this._uploadProgress.resolve(b):this._uploadProgress.notify(b)};
e.prototype._doUpload=function(){if(this._uploadsDone===this.numParts&&this._bytesUploaded+this._bytesResumed===this.file.size)this._closeFile();else if(0<this._uploadQueue.length)return this.uploadPool.acquire().done(function(a){return function(d){var c,b,h,e,f;if(0===a._uploadQueue.length||a._aborted)a.uploadPool.release(d);else return f=a._uploadQueue.shift(),a._partUploadProgress[f.index]=0,a.uploadStartedAt=Date.now(),b=a.api.uploadFilePart(a.fileID,f.index,f.slice,f.md5),a._uploadCalls[f.index]=
b,b.progress(function(b){return a._onUploadProgress(f,b)}),h=function(){delete a._uploadCalls[f.index];null!=d&&(a.uploadPool.release(d),d=null);return a._doUpload()},c=function(){a._uploadQueue.unshift(f);a._partUploadProgress[f.index]=0;a._onUploadProgress(f);return h()},e=b.abort,b.abort=function(){e.call(b);return c()},b.done(function(){a._uploadsDone+=1;a._bytesUploaded+=f.stop-f.start;delete a._partUploadProgress[f.index];return a._onUploadProgress(f,null,a._uploadsDone===a.numParts)}),b.always(h)}}(this))};
e.prototype.monitorChecksumProgress=function(){return this._checksumProgress.promise()};e.prototype.monitorUploadProgress=function(){return this._uploadProgress.promise()};e.prototype.monitorFileClosingProgress=function(){return this._closingProgress.promise()};e.prototype.abort=function(){var a,d,c;if(this._aborted)return $.Deferred().resolve(this.fileID);if(this._closed)return $.Deferred().reject({reason:"File Closed"});this._aborted=!0;this._uploadQueue=[];c=this._uploadCalls;for(d in c)a=c[d],
a.abort();this._uploadsCalls={};return this.fileCreationStatus.done(function(a){return function(){return a.api.call(a.projectID,"removeObjects",{objects:[a.fileID]}).then(function(){a._uploadProgress.reject();return a.fileID})}}(this))};e.prototype.pause=function(){var a,d,c,b;c=this._uploadCalls;b=[];for(d in c)a=c[d],b.push(a.abort());return b};e.prototype.resume=function(){this._computeChecksums();return this._doUpload()};e.prototype.start=function(){return this.fileCreationStatus.done(function(a){return function(){a._computeChecksums();
return a._doUpload()}}(this))};e.prototype.readBytes=function(a,d){var c,b,h,e,f;null==a&&(a=0);null==d&&(d=Infinity);0>a&&(a=Math.max(0,this.file.size+a));0>d&&(d=0);h=$.Deferred();b=null!=(e=null!=(f=this.file.slice)?f:this.file.webkitSlice)?e:this.file.mozSlice;if(null==b)return h.reject("No slice function found for "+this.file.name);b=b.call(this.file,Math.min(this.file.size,a),Math.min(this.file.size,a+d));c=new FileReader;c.onload=function(){return h.resolve(c.result)};c.onerror=function(){return h.reject(c.error)};
c.readAsArrayBuffer(b);return h};return e}();n.exports=m},{}],6:[function(m,n,p){m=function(){function k(g){this._sparkMD5Src=g;this.keyToDeferred={};this.worker=this._makeMD5WebWorker()}k.prototype.computeMD5=function(g){var e;e=this._makeKey();this.keyToDeferred[e]=$.Deferred();this.worker.computeMD5(e,g,function(a){return function(d){return"object"===typeof d&&null!=d.error?a.keyToDeferred[e].reject(d):a.keyToDeferred[e].resolve(d)}}(this));return this.keyToDeferred[e]};k.prototype.terminate=function(){return this.worker.destroy()};
k.prototype._makeKey=function(){return Date.now().toString()+"-"+Math.round(9999999*Math.random())};k.prototype._makeMD5WebWorker=function(){return operative({computeMD5:function(g,e){var a,d,c;c=new FileReaderSync;try{return a=c.readAsArrayBuffer(e),d=SparkMD5.ArrayBuffer.hash(a)}catch(b){return{error:b.name,message:b.message}}}},[this._sparkMD5Src])};return k}();n.exports=m},{}],7:[function(m,n,p){var k,g,e,a,d=function(a,b){return function(){return a.apply(b,arguments)}};k=m("../api.coffee");g=
m("./file_upload.coffee");e=m("./md5_worker.coffee");a=m("../common/resource_pool.coffee");m=function(){function c(b,c,l){var f,g,m,q,n,p,s,v;this._authToken=b;this.files=c;null==l&&(l={});this.start=d(this.start,this);if(!(0<(null!=(m=l.projectID)?m.length:void 0)))throw Error("projectID must be specified");if(!(0<(null!=(q=l.sparkMD5Src)?q.length:void 0)))throw Error("sparkMD5Src must be specified");this.partSize=null!=(n=l.partSize)?n:10485760;this.folder=null!=(p=l.folder)?p:"/";f=null!=(s=l.checksumConcurrency)?
s:10;this.uploadConcurrency=null!=(v=l.uploadConcurrency)?v:10;this.projectID=l.projectID;this.api=new k(this._authToken,l);this.workers=function(){var a,b;b=[];for(g=a=0;0<=f?a<f:a>f;g=0<=f?++a:--a)b.push(new e(l.sparkMD5Src));return b}();this.workerPool=new a(this.workers);b=function(){var a,b,c;c=[];g=a=0;for(b=this.uploadConcurrency;0<=b?a<b:a>b;g=0<=b?++a:--a)c.push("UploadToken "+g);return c}.call(this);this.uploadPool=new a(b);this.fileCreationPool=new a(function(){var a,b,c;c=[];g=a=0;for(b=
this.uploadConcurrency;0<=b?a<b:a>b;g=0<=b?++a:--a)c.push("FileCreateToken "+g);return c}.call(this))}c.prototype.start=function(){var a,c,d,f,e,k,m,n,p;k=$.Deferred();this.uploads=[];a={partSize:this.partSize,workerPool:this.workerPool,uploadPool:this.uploadPool,fileCreationPool:this.fileCreationPool,api:this.api,projectID:this.projectID,folder:this.folder};p=this.files;f=m=0;for(n=p.length;m<n;f=++m)c=p[f],$.isPlainObject(c)&&null!=c.file&&null!=c.options?(d=c.file,c=$.extend(a,c.options)):(d=c,
c=a),this.uploads[f]=new g(d,c);e=function(a){return function(b){a.uploads[b].start();return b===a.uploads.length-1?k.resolve(a.uploads):e(b+1)}}(this);e(0);return k};c.prototype.abort=function(){var a,c,d,f,e,g,k;this.fileCreationPool.close();this.workerPool.close();this.uploadPool.close();d=$.Deferred();c=0;a=[];k=this.uploads;e=0;for(g=k.length;e<g;e++)f=k[e],f.abort().done(function(c){return a.push(c)}).fail(function(a){if("File Closed"!==(null!=a?a.reason:void 0))return d.reject(a)}).always(function(e){return function(){if(++c===
e.uploads.length)return d.resolve(a)}}(this));return d};c.prototype.destroy=function(){var a,c,d,e;e=this.workers;c=0;for(d=e.length;c<d;c++)a=e[c],a.terminate();this.workerPool.close();return this.uploadPool.close()};c.prototype.pause=function(){var a,c,d,e,g;this.workerPool.close();this.uploadPool.close();e=this.uploads;g=[];c=0;for(d=e.length;c<d;c++)a=e[c],g.push(a.pause());return g};c.prototype.resume=function(){var a,c,d,e;e=this.uploads;c=0;for(d=e.length;c<d;c++)a=e[c],a.resume();this.workerPool.open();
return this.uploadPool.open()};return c}();n.exports=m},{"../api.coffee":2,"../common/resource_pool.coffee":3,"./file_upload.coffee":5,"./md5_worker.coffee":6}]},{},[4]);
